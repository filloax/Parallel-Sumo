CC=g++
# include traciapi to fix config file path.
# wininit is needed in all files to properly initialize windows flags to avoid
# GNU compilation conflicts (mainly winsock select vs sys/select).
# Some files might still include it manually for better IDE recognition.
CXXFLAGS= -std=gnu++20 -I. -g -I./libs/traciapi -I "${SUMO_HOME}/include" -include "libs/wininit.h"
LIBS= -lws2_32 -ldbghelp
BIN_DIR = bin
OBJ_DIR = .obj
SOURCES := $(shell find * -type f -name "*.cpp" -o -name "*.c")
SRC_LST := $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCES)))
OBJECTS := $(addprefix $(OBJ_DIR)/,$(SRC_LST))

all: clean main

clean:
	@echo "Cleaning"
	rm -rf $(OBJ_DIR)/*
	rm -f $(BIN_DIR)/main.exe

main: $(BIN_DIR)/main

$(BIN_DIR)/main: $(OBJECTS)
	@echo "Linking"
	@mkdir -p $(@D)
	$(CC) $^ ${LIBS} -o $(BIN_DIR)/main.exe

# %.o: %.cpp
# 	$(CC) $(CXXFLAGS) -c $< -o $@

.SECONDEXPANSION:
$(OBJECTS): $(OBJ_DIR)/%.o: $$(wildcard %.c*)
	@mkdir -p $(@D)
ifeq "$(suffix $<)" ".cpp"
	$(CC) -MMD -MP $(CXXFLAGS) -c $< -o $@ 
else
#equal for now
	$(CC) -MMD -MP $(CXXFLAGS) -c $< -o $@
endif

-include $(OBJECTS:.o=.d)